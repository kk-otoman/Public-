<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>政企积分计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .input-field, .select-field {
            @apply w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out;
        }
        .radio-label, .checkbox-label {
            @apply ml-2 text-sm text-gray-700;
        }
        .radio-group, .checkbox-group {
             @apply flex items-center space-x-4 mt-1 flex-wrap;
        }
        /* Final Style - Bold, Dark Blue Text, No Button Background/Shape */
        .calculate-button {
            @apply w-full text-center text-blue-800 font-bold py-3 px-4 mt-8 text-lg cursor-pointer hover:text-blue-600 transition duration-150 ease-in-out;
             /* Applied text-blue-800 and font-bold. Removed background/border-radius. */
        }
        .result-box {
            @apply mt-6 p-4 bg-blue-100 border border-blue-300 text-blue-800 rounded-md text-left;
        }
        .error-box {
             @apply mt-6 p-4 bg-red-100 border border-red-300 text-red-800 rounded-md text-center font-semibold;
        }
        .section-title {
            @apply text-lg font-semibold text-gray-700 mb-3 border-t border-gray-200 pt-4 mt-4;
        }
        .sub-section {
             @apply mt-4 border-l-2 border-indigo-200 pl-4;
        }
        .hidden-section {
            display: none;
        }
        .formula-display, .notes-display {
            @apply text-sm text-gray-500 mt-1 italic;
        }
        label { @apply mb-1; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-xl w-full">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">政企积分计算器</h1>

        <div class="mb-4">
            <span class="block text-sm font-medium text-gray-700 mb-1">计算类型:</span>
            <div class="radio-group">
                <div class="flex items-center mr-4 mb-2">
                    <input type="radio" id="type_mobile" name="calc_type" value="mobile" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                    <label for="type_mobile" class="radio-label">手机套餐</label>
                </div>
                <div class="flex items-center mr-4 mb-2">
                    <input type="radio" id="type_broadband" name="calc_type" value="broadband" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                    <label for="type_broadband" class="radio-label">单宽</label>
                </div>
                <div class="flex items-center mr-4 mb-2">
                    <input type="radio" id="type_convergence" name="calc_type" value="convergence" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                    <label for="type_convergence" class="radio-label">移宽融合</label>
                </div>
                 <div class="flex items-center mr-4 mb-2">
                    <input type="radio" id="type_dual_line" name="calc_type" value="dual_line" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                    <label for="type_dual_line" class="radio-label">双线</label>
                </div>
                <div class="flex items-center mr-4 mb-2">
                    <input type="radio" id="type_fixed_app" name="calc_type" value="fixed_app" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                    <label for="type_fixed_app" class="radio-label">固网应用</label>
                </div>
                 <div class="flex items-center mb-2">
                    <input type="radio" id="type_ict" name="calc_type" value="ict" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                    <label for="type_ict" class="radio-label">ICT项目</label>
                </div>
            </div>
        </div>

        <div id="mobile_section" class="mb-4">
              <p class="text-sm text-center text-gray-500 mb-4">(默认按单卡系数 0.8 计算)</p>
             <div class="mb-4">
                 <label for="mobile_price" class="block text-sm font-medium text-gray-700">套餐月租 (元):</label>
                 <input type="number" id="mobile_price" name="mobile_price" placeholder="例如: 29" class="input-field">
             </div>
             <div class="mb-4">
                 <span class="block text-sm font-medium text-gray-700">本网异网系数:</span>
                 <div class="radio-group">
                     <div class="flex items-center">
                         <input type="radio" id="network_same" name="network_type_mobile" value="0.5" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                         <label for="network_same" class="radio-label">本网 (系数 0.5)</label>
                     </div>
                     <div class="flex items-center">
                         <input type="radio" id="network_diff" name="network_type_mobile" value="1.2" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                         <label for="network_diff" class="radio-label">异网 (系数 1.2)</label>
                     </div>
                 </div>
             </div>
             <div class="mb-4">
                 <span class="block text-sm font-medium text-gray-700">是否企业证件入网:</span>
                 <div class="radio-group">
                     <div class="flex items-center">
                         <input type="radio" id="biz_cert_mobile_yes" name="biz_cert_mobile" value="1.6" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                         <label for="biz_cert_mobile_yes" class="radio-label">是 (系数 1.6)</label>
                     </div>
                     <div class="flex items-center">
                         <input type="radio" id="biz_cert_mobile_no" name="biz_cert_mobile" value="1.0" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                         <label for="biz_cert_mobile_no" class="radio-label">否 (系数 1.0)</label>
                     </div>
                 </div>
             </div>
        </div>

        <div id="broadband_section" class="hidden-section mb-4">
              <h2 class="section-title">单宽信息</h2>
            <div class="mb-4">
                <span class="block text-sm font-medium text-gray-700">单宽类型:</span>
                <div class="radio-group">
                    <div class="flex items-center">
                        <input type="radio" id="bb_type_non_annual" name="broadband_type" value="non_annual" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                        <label for="bb_type_non_annual" class="radio-label">新入网非包年</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="bb_type_annual" name="broadband_type" value="annual" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <label for="bb_type_annual" class="radio-label">新入网包年</label>
                    </div>
                </div>
            </div>
            <div id="non_annual_section">
                <div class="mb-4">
                    <label for="monthly_contribution" class="block text-sm font-medium text-gray-700">月费贡献金额 (元):</label>
                    <input type="number" id="monthly_contribution" name="monthly_contribution" placeholder="例如: 50" class="input-field">
                </div>
                 <div class="mb-4">
                    <span class="block text-sm font-medium text-gray-700">名单情况:</span>
                     <div class="radio-group">
                         <div class="flex items-center">
                             <input type="radio" id="list_status_non_annual_in" name="list_status_non_annual" value="1.1" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                             <label for="list_status_non_annual_in" class="radio-label">名单内 (系数 1.1)</label>
                         </div>
                         <div class="flex items-center">
                             <input type="radio" id="list_status_non_annual_out" name="list_status_non_annual" value="0.9" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                             <label for="list_status_non_annual_out" class="radio-label">非名单内 (系数 0.9)</label>
                         </div>
                     </div>
                 </div>
                 <div class="mb-4">
                     <span class="block text-sm font-medium text-gray-700">是否叠加FTTO:</span>
                     <div class="radio-group">
                         <div class="flex items-center">
                             <input type="radio" id="ftto_non_annual_yes" name="ftto_non_annual" value="1.2" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                             <label for="ftto_non_annual_yes" class="radio-label">是 (系数 1.2)</label>
                         </div>
                         <div class="flex items-center">
                             <input type="radio" id="ftto_non_annual_no" name="ftto_non_annual" value="1.0" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                             <label for="ftto_non_annual_no" class="radio-label">否 (系数 1.0)</label>
                         </div>
                     </div>
                 </div>
            </div>
            <div id="annual_section" class="hidden-section">
                 <div class="mb-4">
                    <label for="annual_payment" class="block text-sm font-medium text-gray-700">年费趸交款 (元):</label>
                    <input type="number" id="annual_payment" name="annual_payment" placeholder="例如: 1200" class="input-field">
                </div>
                <div class="mb-4">
                    <span class="block text-sm font-medium text-gray-700">趸交年限:</span>
                     <div class="radio-group">
                         <div class="flex items-center">
                             <input type="radio" id="lump_sum_1" name="lump_sum_duration" value="1.0" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                             <label for="lump_sum_1" class="radio-label">1年 (系数 1.0)</label>
                         </div>
                         <div class="flex items-center">
                             <input type="radio" id="lump_sum_2plus" name="lump_sum_duration" value="1.3" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                             <label for="lump_sum_2plus" class="radio-label">2年及以上 (系数 1.3)</label>
                         </div>
                     </div>
                 </div>
                 <div class="mb-4">
                    <span class="block text-sm font-medium text-gray-700">名单情况:</span>
                     <div class="radio-group">
                         <div class="flex items-center">
                             <input type="radio" id="list_status_annual_in" name="list_status_annual" value="1.1" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                             <label for="list_status_annual_in" class="radio-label">名单内 (系数 1.1)</label>
                         </div>
                         <div class="flex items-center">
                             <input type="radio" id="list_status_annual_out" name="list_status_annual" value="0.9" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                             <label for="list_status_annual_out" class="radio-label">非名单内 (系数 0.9)</label>
                         </div>
                     </div>
                 </div>
                 <div class="mb-4">
                     <span class="block text-sm font-medium text-gray-700">是否叠加FTTO:</span>
                     <div class="radio-group">
                         <div class="flex items-center">
                             <input type="radio" id="ftto_annual_yes" name="ftto_annual" value="1.2" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                             <label for="ftto_annual_yes" class="radio-label">是 (系数 1.2)</label>
                         </div>
                         <div class="flex items-center">
                             <input type="radio" id="ftto_annual_no" name="ftto_annual" value="1.0" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                             <label for="ftto_annual_no" class="radio-label">否 (系数 1.0)</label>
                         </div>
                     </div>
                 </div>
            </div>
        </div>

        <div id="convergence_section" class="hidden-section mb-4">
              <h2 class="section-title">移宽融合信息</h2>
            <div class="mb-4">
                <label for="convergence_contribution" class="block text-sm font-medium text-gray-700">入网套餐值贡献金额 (元):</label>
                <input type="number" id="convergence_contribution" name="convergence_contribution" placeholder="例如: 100" class="input-field">
            </div>
            <div class="mb-4">
                <span class="block text-sm font-medium text-gray-700">本网异网系数:</span>
                 <div class="radio-group">
                     <div class="flex items-center">
                         <input type="radio" id="network_type_convergence_same" name="network_type_convergence" value="0.5" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                         <label for="network_type_convergence_same" class="radio-label">本网 (系数 0.5)</label>
                     </div>
                     <div class="flex items-center">
                         <input type="radio" id="network_type_convergence_diff" name="network_type_convergence" value="1.2" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                         <label for="network_type_convergence_diff" class="radio-label">异网 (系数 1.2)</label>
                     </div>
                 </div>
            </div>
            <div class="mb-4">
                <span class="block text-sm font-medium text-gray-700">名单情况:</span>
                 <div class="radio-group">
                     <div class="flex items-center">
                         <input type="radio" id="list_status_convergence_in" name="list_status_convergence" value="1.1" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                         <label for="list_status_convergence_in" class="radio-label">名单内 (系数 1.1)</label>
                     </div>
                     <div class="flex items-center">
                         <input type="radio" id="list_status_convergence_out" name="list_status_convergence" value="0.9" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                         <label for="list_status_convergence_out" class="radio-label">非名单内 (系数 0.9)</label>
                     </div>
                 </div>
            </div>
             <div class="mb-4">
                 <span class="block text-sm font-medium text-gray-700">是否企业证件入网:</span>
                 <div class="radio-group">
                     <div class="flex items-center">
                         <input type="radio" id="biz_cert_convergence_yes" name="biz_cert_convergence" value="1.6" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                         <label for="biz_cert_convergence_yes" class="radio-label">是 (系数 1.6)</label>
                     </div>
                     <div class="flex items-center">
                         <input type="radio" id="biz_cert_convergence_no" name="biz_cert_convergence" value="1.0" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                         <label for="biz_cert_convergence_no" class="radio-label">否 (系数 1.0)</label>
                     </div>
                 </div>
             </div>
             <div class="mb-4">
                 <span class="block text-sm font-medium text-gray-700">是否沃企融合:</span>
                 <div class="radio-group">
                     <div class="flex items-center">
                         <input type="radio" id="woqi_yes" name="woqi" value="1.2" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                         <label for="woqi_yes" class="radio-label">是 (系数 1.2)</label>
                     </div>
                     <div class="flex items-center">
                         <input type="radio" id="woqi_no" name="woqi" value="1.0" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                         <label for="woqi_no" class="radio-label">否 (系数 1.0)</label>
                     </div>
                 </div>
             </div>
        </div>

        <div id="dual_line_section" class="hidden-section mb-4">
             <h2 class="section-title">双线信息</h2>
            <div class="mb-4">
                <label for="dual_line_subtype" class="block text-sm font-medium text-gray-700">双线品类:</label>
                <select id="dual_line_subtype" name="dual_line_subtype" class="select-field">
                    <option value="internet_non_annual">互联网专线(不含国际)-非包年</option>
                    <option value="internet_annual">互联网专线(不含国际)-包年</option>
                    <option value="traditional_cloud">租线-传统电路、云网融合</option>
                    <option value="international">互联网专线、租线-国际业务</option>
                    <option value="dark_fiber">租线-裸光纤、管道出租</option>
                </select>
                 <div id="dl_formula_display" class="formula-display"></div>
            </div>
            <div id="dl_common_inputs" class="sub-section">
                 <div class="mb-4">
                     <label for="dl_revenue" class="block text-sm font-medium text-gray-700">年准财收入 (元):</label>
                     <input type="number" id="dl_revenue" name="dl_revenue" placeholder="输入年度总收入" class="input-field">
                 </div>
                 <div id="dl_cost_input" class="mb-4 hidden-section">
                     <label for="dl_cost" class="block text-sm font-medium text-gray-700">年结入成本/成本 (元):</label>
                     <input type="number" id="dl_cost" name="dl_cost" placeholder="输入年度总成本" class="input-field">
                 </div>
                 <div class="mb-4">
                    <span class="block text-sm font-medium text-gray-700">名单情况:</span>
                     <div class="radio-group">
                         <div class="flex items-center">
                             <input type="radio" id="list_status_dl_in" name="list_status_dl" value="1.1" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                             <label for="list_status_dl_in" class="radio-label">名单内 (系数 1.1)</label>
                         </div>
                         <div class="flex items-center">
                             <input type="radio" id="list_status_dl_out" name="list_status_dl" value="0.9" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                             <label for="list_status_dl_out" class="radio-label">非名单内 (系数 0.9)</label>
                         </div>
                     </div>
                 </div>
            </div>
        </div>

        <div id="fixed_app_section" class="hidden-section mb-4">
              <h2 class="section-title">固网应用信息</h2>
             <div class="mb-4">
                <label for="fixed_app_subtype" class="block text-sm font-medium text-gray-700">固网应用品类:</label>
                <select id="fixed_app_subtype" name="fixed_app_subtype" class="select-field">
                    <option value="other_fixed">语音固话、语音增值(不含BPO/云讯通)、宽带增值等</option>
                    <option value="yunxuntong">语音增值-云讯通</option>
                </select>
                 <div id="fa_formula_display" class="formula-display"></div>
            </div>
             <div id="fa_common_inputs" class="sub-section">
                  <div class="mb-4">
                     <label for="fa_revenue" class="block text-sm font-medium text-gray-700">年准财收入 (元):</label>
                     <input type="number" id="fa_revenue" name="fa_revenue" placeholder="输入年度总收入" class="input-field">
                 </div>
                 <div id="fa_cost_input" class="mb-4 hidden-section">
                     <label for="fa_cost" class="block text-sm font-medium text-gray-700">年成本 (元):</label>
                     <input type="number" id="fa_cost" name="fa_cost" placeholder="输入年度总成本" class="input-field">
                 </div>
             </div>
        </div>

        <div id="ict_section" class="hidden-section mb-4">
            <h2 class="section-title">ICT项目信息</h2>
            <div class="notes-display mb-4">
                说明：按回款计算积分。单项目总积分上限6万，单月单项目积分上限5千。
            </div>
            <div class="mb-4">
                <label for="ict_amount_received" class="block text-sm font-medium text-gray-700">项目已回款金额累计值 (元):</label>
                <input type="number" id="ict_amount_received" name="ict_amount_received" placeholder="输入项目累计已回款总额" class="input-field">
            </div>
             <div class="mb-4">
                <label for="ict_gross_margin_rate" class="block text-sm font-medium text-gray-700">项目总累计毛利率 (%):</label>
                <input type="number" id="ict_gross_margin_rate" name="ict_gross_margin_rate" placeholder="例如: 15 (表示15%)" class="input-field">
            </div>
             <div class="mb-4">
                <label for="ict_total_revenue" class="block text-sm font-medium text-gray-700">项目收入总额 (元):</label>
                <input type="number" id="ict_total_revenue" name="ict_total_revenue" placeholder="用于判断利润系数规则 (500万阈值)" class="input-field">
            </div>
             <div class="mb-4">
                <label for="ict_dev_contribution_ratio" class="block text-sm font-medium text-gray-700">发展人贡献比 (%):</label>
                <input type="number" id="ict_dev_contribution_ratio" name="ict_dev_contribution_ratio" placeholder="例如: 100 (表示100%)" class="input-field">
            </div>
            <div class="mb-4">
                <label for="ict_historical_points" class="block text-sm font-medium text-gray-700">项目历史已累计发放积分:</label>
                <input type="number" id="ict_historical_points" name="ict_historical_points" placeholder="输入该项目此前已发放积分总和" class="input-field">
            </div>
        </div>


        <button id="calculateBtn" class="calculate-button">计算积分</button>

        <div id="result" class="mt-6"></div>

    </div>

    <script>
        // --- DOM Element References ---
        const calcTypeRadios = document.querySelectorAll('input[name="calc_type"]');
        const mobileSection = document.getElementById('mobile_section');
        const broadbandSection = document.getElementById('broadband_section');
        const convergenceSection = document.getElementById('convergence_section');
        const dualLineSection = document.getElementById('dual_line_section');
        const fixedAppSection = document.getElementById('fixed_app_section');
        const ictSection = document.getElementById('ict_section'); // ICT Section

        const broadbandTypeRadios = document.querySelectorAll('input[name="broadband_type"]');
        const nonAnnualSection = document.getElementById('non_annual_section');
        const annualSection = document.getElementById('annual_section');

        // Dual Line Elements
        const dualLineSubtypeSelect = document.getElementById('dual_line_subtype');
        const dlRevenueInput = document.getElementById('dl_revenue');
        const dlCostInputDiv = document.getElementById('dl_cost_input');
        const dlCostInput = document.getElementById('dl_cost');
        const dlFormulaDisplay = document.getElementById('dl_formula_display');

        // Fixed App Elements
        const fixedAppSubtypeSelect = document.getElementById('fixed_app_subtype');
        const faRevenueInput = document.getElementById('fa_revenue');
        const faCostInputDiv = document.getElementById('fa_cost_input');
        const faCostInput = document.getElementById('fa_cost');
        const faFormulaDisplay = document.getElementById('fa_formula_display');

        // ICT Elements
        const ictAmountReceivedInput = document.getElementById('ict_amount_received');
        const ictGrossMarginRateInput = document.getElementById('ict_gross_margin_rate');
        const ictTotalRevenueInput = document.getElementById('ict_total_revenue');
        const ictDevContributionRatioInput = document.getElementById('ict_dev_contribution_ratio');
        const ictHistoricalPointsInput = document.getElementById('ict_historical_points');


        const mobilePriceInput = document.getElementById('mobile_price');
        const monthlyContributionInput = document.getElementById('monthly_contribution');
        const annualPaymentInput = document.getElementById('annual_payment');
        const convergenceContributionInput = document.getElementById('convergence_contribution');

        const calculateBtn = document.getElementById('calculateBtn');
        const resultDiv = document.getElementById('result');

        // --- Constants ---
        const defaultCardTypeCoefficient = 0.8;
        const convergenceBaseMultiplier = 1.8;
        const BASE_COEFF_085 = 0.085;
        const INTERNET_ANNUAL_COEFF = 0.22;
        const DARK_FIBER_COEFF = 0.6;
        const ICT_PROFIT_COEFF_BASE = 0.15;
        const ICT_TOTAL_POINTS_CAP = 60000;
        const ICT_MONTHLY_POINTS_CAP = 5000;
        const ICT_REVENUE_THRESHOLD = 5000000;
        const ICT_MARGIN_THRESHOLD_LOW = 10; // 10%
        const ICT_MARGIN_THRESHOLD_HIGH = 15; // 15%


        // --- Helper Functions ---
        function hideAllSections() {
            mobileSection.classList.add('hidden-section');
            broadbandSection.classList.add('hidden-section');
            convergenceSection.classList.add('hidden-section');
            dualLineSection.classList.add('hidden-section');
            fixedAppSection.classList.add('hidden-section');
            ictSection.classList.add('hidden-section'); // Hide ICT section
        }

        function clearResult() {
            resultDiv.innerHTML = '';
            resultDiv.className = 'mt-6';
        }

        // Function to update formula display text
        function updateFormulaDisplay(selectElement, displayElement) {
            const selectedValue = selectElement.value;
            let formulaText = '';

            if (selectElement.id === 'dual_line_subtype') {
                switch (selectedValue) {
                    case 'internet_non_annual':
                        formulaText = '积分标准：准财收入 × 0.085 × 名单系数 (按月均值*12个月计算收入)';
                        break;
                    case 'internet_annual':
                        formulaText = '积分标准：准财收入 × 0.22 × 名单系数 (按12个月计算收入)';
                        break;
                    case 'traditional_cloud':
                        formulaText = '积分标准：准财收入 × 0.085 × 名单系数 (按12个月计算收入)';
                        break;
                    case 'international':
                        formulaText = '积分标准：毛利额 × 0.085 × 名单系数 (毛利额=准财收入-结入成本, 按12个月计算)';
                        break;
                    case 'dark_fiber':
                        formulaText = '积分标准：准财收入 × 0.085 × 0.6 × 名单系数 (按12个月计算收入)';
                        break;
                }
            } else if (selectElement.id === 'fixed_app_subtype') {
                 switch (selectedValue) {
                    case 'other_fixed':
                        formulaText = '积分标准：准财收入 × 0.085 (按12个月计算收入/毛利)';
                        break;
                    case 'yunxuntong':
                         formulaText = '积分标准：毛利额 × 0.085 (毛利额=准财收入-成本, 按12个月计算)';
                        break;
                 }
            }
            displayElement.textContent = formulaText;
        }


        // --- Event Listeners ---

        // Listener for Main Calculation Type
        calcTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                hideAllSections();
                clearResult();

                switch(this.value) {
                    case 'mobile':
                        mobileSection.classList.remove('hidden-section');
                        break;
                    case 'broadband':
                        broadbandSection.classList.remove('hidden-section');
                        document.querySelector('input[name="broadband_type"]:checked').dispatchEvent(new Event('change'));
                        break;
                    case 'convergence':
                        convergenceSection.classList.remove('hidden-section');
                        break;
                    case 'dual_line':
                        dualLineSection.classList.remove('hidden-section');
                        dualLineSubtypeSelect.dispatchEvent(new Event('change'));
                        break;
                    case 'fixed_app':
                        fixedAppSection.classList.remove('hidden-section');
                        fixedAppSubtypeSelect.dispatchEvent(new Event('change'));
                        break;
                    case 'ict': // Handle ICT selection
                        ictSection.classList.remove('hidden-section');
                        break;
                }
            });
        });

        // Listener for Broadband Sub-Type
        broadbandTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                clearResult();
                if (this.value === 'non_annual') {
                    nonAnnualSection.classList.remove('hidden-section');
                    annualSection.classList.add('hidden-section');
                } else {
                    nonAnnualSection.classList.add('hidden-section');
                    annualSection.classList.remove('hidden-section');
                }
            });
        });

         // Listener for Dual Line Sub-Type Change
        dualLineSubtypeSelect.addEventListener('change', function() {
             clearResult();
             if (this.value === 'international') {
                 dlCostInputDiv.classList.remove('hidden-section');
             } else {
                 dlCostInputDiv.classList.add('hidden-section');
             }
             updateFormulaDisplay(this, dlFormulaDisplay);
         });

        // Listener for Fixed App Sub-Type Change
        fixedAppSubtypeSelect.addEventListener('change', function() {
             clearResult();
             if (this.value === 'yunxuntong') {
                 faCostInputDiv.classList.remove('hidden-section');
             } else {
                 faCostInputDiv.classList.add('hidden-section');
             }
             updateFormulaDisplay(this, faFormulaDisplay);
         });


        // Listener for Calculate Button
        calculateBtn.addEventListener('click', () => {
            clearResult();

            const selectedCalcType = document.querySelector('input[name="calc_type"]:checked').value;
            let finalScore = 0; // Represents the final points for the month for ICT
            let detailsHtml = '';
            let calculationFactors = {};

            try {
                switch(selectedCalcType) {
                    case 'mobile':
                        const price = parseFloat(mobilePriceInput.value);
                        if (isNaN(price) || price <= 0) throw new Error('请输入有效的套餐月租！');
                        const networkTypeCoefficient = parseFloat(document.querySelector('input[name="network_type_mobile"]:checked').value);
                        const cardTypeCoefficient = defaultCardTypeCoefficient;
                        const bizCertCoefficientMobile = parseFloat(document.querySelector('input[name="biz_cert_mobile"]:checked').value);
                        let priceCoefficient;
                        if (price >= 99) priceCoefficient = 1.2;
                        else if (price >= 39) priceCoefficient = 0.8;
                        else priceCoefficient = 0.25;
                        finalScore = price * priceCoefficient * networkTypeCoefficient * cardTypeCoefficient * bizCertCoefficientMobile;
                        calculationFactors = {
                            '计算类型': '手机套餐', '月租': `${price.toFixed(2)} 元`, '价格系数': priceCoefficient.toFixed(2),
                            '本网异网系数': networkTypeCoefficient.toFixed(2), '卡类型系数': `${cardTypeCoefficient.toFixed(2)} (默认单卡)`,
                            '企业证件系数': bizCertCoefficientMobile.toFixed(2)
                        };
                        break;

                    case 'broadband':
                        const selectedBroadbandType = document.querySelector('input[name="broadband_type"]:checked').value;
                        if (selectedBroadbandType === 'non_annual') {
                            const monthlyContribution = parseFloat(monthlyContributionInput.value);
                            if (isNaN(monthlyContribution) || monthlyContribution <= 0) throw new Error('请输入有效的月费贡献金额！');
                            // Re-added base coefficient 0.8 for non-annual broadband
                            const baseCoefficientBB = 0.8;
                            const contributionCoefficient = monthlyContribution >= 30 ? 1.0 : 0.3;
                            const listCoefficient = parseFloat(document.querySelector('input[name="list_status_non_annual"]:checked').value);
                            const fttoCoefficient = parseFloat(document.querySelector('input[name="ftto_non_annual"]:checked').value);
                            // Updated calculation to include baseCoefficientBB
                            finalScore = monthlyContribution * baseCoefficientBB * contributionCoefficient * listCoefficient * fttoCoefficient;
                            calculationFactors = {
                                '计算类型': '单宽 (新入网非包年)', '月费贡献金额': `${monthlyContribution.toFixed(2)} 元`,
                                '基础系数': baseCoefficientBB.toFixed(2), // Added back for display
                                '贡献值系数': `${contributionCoefficient.toFixed(2)} (${monthlyContribution >= 30 ? '≥ 30元' : '< 30元'})`,
                                '名单系数': listCoefficient.toFixed(2), 'FTTO系数': fttoCoefficient.toFixed(2)
                            };
                        } else { // annual
                            const annualPayment = parseFloat(annualPaymentInput.value);
                            if (isNaN(annualPayment) || annualPayment <= 0) throw new Error('请输入有效的年费趸交款！');
                            const baseCoefficient = 0.2;
                            const durationCoefficient = parseFloat(document.querySelector('input[name="lump_sum_duration"]:checked').value);
                            const listCoefficient = parseFloat(document.querySelector('input[name="list_status_annual"]:checked').value);
                            const fttoCoefficient = parseFloat(document.querySelector('input[name="ftto_annual"]:checked').value);
                            finalScore = annualPayment * baseCoefficient * durationCoefficient * listCoefficient * fttoCoefficient;
                            calculationFactors = {
                                '计算类型': '单宽 (新入网包年)', '年费趸交款': `${annualPayment.toFixed(2)} 元`, '基础系数': baseCoefficient.toFixed(2),
                                '年限系数': `${durationCoefficient.toFixed(2)} (${durationCoefficient === 1.0 ? '1年' : '≥ 2年'})`,
                                '名单系数': listCoefficient.toFixed(2), 'FTTO系数': fttoCoefficient.toFixed(2)
                            };
                        }
                        break;

                    case 'convergence':
                         const contribution = parseFloat(convergenceContributionInput.value);
                         if (isNaN(contribution) || contribution <= 0) throw new Error('请输入有效的入网套餐值贡献金额！');
                         const networkCoefficientConv = parseFloat(document.querySelector('input[name="network_type_convergence"]:checked').value);
                         const listCoefficientConv = parseFloat(document.querySelector('input[name="list_status_convergence"]:checked').value);
                         const bizCertCoefficientConv = parseFloat(document.querySelector('input[name="biz_cert_convergence"]:checked').value);
                         const woqiCoefficient = parseFloat(document.querySelector('input[name="woqi"]:checked').value);
                         let contributionValueCoefficient;
                         let contributionRangeText;
                         if (contribution >= 99) { contributionValueCoefficient = 1.2; contributionRangeText = '≥ 99元'; }
                         else if (contribution >= 39) { contributionValueCoefficient = 0.8; contributionRangeText = '39-98元'; }
                         else { contributionValueCoefficient = 0.25; contributionRangeText = '< 39元'; }
                         finalScore = contribution * convergenceBaseMultiplier * networkCoefficientConv * contributionValueCoefficient * listCoefficientConv * bizCertCoefficientConv * woqiCoefficient;
                         calculationFactors = {
                             '计算类型': '移宽融合', '入网套餐值贡献金额': `${contribution.toFixed(2)} 元`, '基础乘数': convergenceBaseMultiplier.toFixed(2),
                             '本网异网系数': networkCoefficientConv.toFixed(2), '贡献值系数': `${contributionValueCoefficient.toFixed(2)} (${contributionRangeText})`,
                             '名单系数': listCoefficientConv.toFixed(2), '企业证件系数': bizCertCoefficientConv.toFixed(2), '沃企融合系数': woqiCoefficient.toFixed(2)
                         };
                        break;

                    case 'dual_line':
                        const selectedDualLineType = dualLineSubtypeSelect.value;
                        const dlRevenue = parseFloat(dlRevenueInput.value);
                        if (isNaN(dlRevenue) || dlRevenue < 0) throw new Error('请输入有效的年准财收入！');
                        const dlListCoefficient = parseFloat(document.querySelector('input[name="list_status_dl"]:checked').value);
                        let dlCost = 0;
                        let profit = dlRevenue;
                        const selectedDlOptionText = dualLineSubtypeSelect.options[dualLineSubtypeSelect.selectedIndex].text;

                        calculationFactors = {
                            '计算类型': `双线`,
                            '品类': selectedDlOptionText,
                            '年准财收入': `${dlRevenue.toFixed(2)} 元`,
                        };

                        if (selectedDualLineType === 'international') {
                            dlCost = parseFloat(dlCostInput.value);
                            if (isNaN(dlCost) || dlCost < 0) throw new Error('请输入有效的年结入成本！');
                            profit = dlRevenue - dlCost;
                            calculationFactors['年结入成本'] = `${dlCost.toFixed(2)} 元`;
                            calculationFactors['毛利额'] = `${profit.toFixed(2)} 元`;
                            finalScore = profit * BASE_COEFF_085 * dlListCoefficient;
                            calculationFactors['基础系数'] = BASE_COEFF_085.toFixed(3);
                        } else if (selectedDualLineType === 'internet_non_annual') {
                            finalScore = dlRevenue * BASE_COEFF_085 * dlListCoefficient;
                             calculationFactors['基础系数'] = BASE_COEFF_085.toFixed(3);
                        } else if (selectedDualLineType === 'internet_annual') {
                            finalScore = dlRevenue * INTERNET_ANNUAL_COEFF * dlListCoefficient;
                             calculationFactors['基础系数'] = INTERNET_ANNUAL_COEFF.toFixed(3);
                        } else if (selectedDualLineType === 'traditional_cloud') {
                            finalScore = dlRevenue * BASE_COEFF_085 * dlListCoefficient;
                             calculationFactors['基础系数'] = BASE_COEFF_085.toFixed(3);
                        } else if (selectedDualLineType === 'dark_fiber') {
                            finalScore = dlRevenue * BASE_COEFF_085 * DARK_FIBER_COEFF * dlListCoefficient;
                            calculationFactors['基础系数'] = BASE_COEFF_085.toFixed(3);
                            calculationFactors['光纤/管道系数'] = DARK_FIBER_COEFF.toFixed(2);
                        }
                        calculationFactors['名单系数'] = dlListCoefficient.toFixed(2);
                        break;

                    case 'fixed_app':
                        const selectedFixedAppType = fixedAppSubtypeSelect.value;
                        const faRevenue = parseFloat(faRevenueInput.value);
                         if (isNaN(faRevenue) || faRevenue < 0) throw new Error('请输入有效的年准财收入！');
                        let faCost = 0;
                        let faProfit = faRevenue;
                        const selectedFaOptionText = fixedAppSubtypeSelect.options[fixedAppSubtypeSelect.selectedIndex].text;

                         calculationFactors = {
                            '计算类型': `固网应用`,
                            '品类': selectedFaOptionText,
                            '年准财收入': `${faRevenue.toFixed(2)} 元`,
                         };

                        if (selectedFixedAppType === 'yunxuntong') {
                            faCost = parseFloat(faCostInput.value);
                             if (isNaN(faCost) || faCost < 0) throw new Error('请输入有效的年成本！');
                            faProfit = faRevenue - faCost;
                            calculationFactors['年成本'] = `${faCost.toFixed(2)} 元`;
                            calculationFactors['毛利额'] = `${faProfit.toFixed(2)} 元`;
                            finalScore = faProfit * BASE_COEFF_085;
                        } else { // other_fixed
                            finalScore = faRevenue * BASE_COEFF_085;
                        }
                         calculationFactors['基础系数'] = BASE_COEFF_085.toFixed(3);
                        break;

                    case 'ict': // ICT Project Calculation
                        const amountReceived = parseFloat(ictAmountReceivedInput.value);
                        const grossMarginRate = parseFloat(ictGrossMarginRateInput.value); // Input as percentage e.g., 15
                        const totalRevenue = parseFloat(ictTotalRevenueInput.value);
                        const devContributionRatio = parseFloat(ictDevContributionRatioInput.value); // Input as percentage e.g., 100
                        const historicalPoints = parseFloat(ictHistoricalPointsInput.value);

                        // Validation
                        if (isNaN(amountReceived) || amountReceived < 0) throw new Error('请输入有效的项目已回款金额累计值！');
                        if (isNaN(grossMarginRate)) throw new Error('请输入有效的项目总累计毛利率！'); // Can be negative
                        if (isNaN(totalRevenue) || totalRevenue < 0) throw new Error('请输入有效的项目收入总额！');
                        if (isNaN(devContributionRatio) || devContributionRatio < 0 || devContributionRatio > 100) throw new Error('请输入有效的发展人贡献比 (0-100)！');
                        if (isNaN(historicalPoints) || historicalPoints < 0) throw new Error('请输入有效的项目历史已累计发放积分！');

                        // 1. Calculate Profit Coefficient (利润系数)
                        let profitCoefficient = 0;
                        let profitCoefficientDesc = "毛利率≤0";
                        if (grossMarginRate > 0) {
                            if (totalRevenue < ICT_REVENUE_THRESHOLD) { // < 5 million
                                if (grossMarginRate >= ICT_MARGIN_THRESHOLD_HIGH) { // >= 15%
                                    profitCoefficient = ICT_PROFIT_COEFF_BASE;
                                    profitCoefficientDesc = `收入<${ICT_REVENUE_THRESHOLD/10000}万, 毛利率≥${ICT_MARGIN_THRESHOLD_HIGH}%`;
                                } else { // < 15%
                                    profitCoefficient = ICT_PROFIT_COEFF_BASE * (grossMarginRate / ICT_MARGIN_THRESHOLD_HIGH);
                                     profitCoefficientDesc = `收入<${ICT_REVENUE_THRESHOLD/10000}万, 毛利率<${ICT_MARGIN_THRESHOLD_HIGH}%`;
                                }
                            } else { // >= 5 million
                                if (grossMarginRate >= ICT_MARGIN_THRESHOLD_LOW) { // >= 10%
                                     profitCoefficient = ICT_PROFIT_COEFF_BASE;
                                     profitCoefficientDesc = `收入≥${ICT_REVENUE_THRESHOLD/10000}万, 毛利率≥${ICT_MARGIN_THRESHOLD_LOW}%`;
                                } else { // < 10%
                                     profitCoefficient = ICT_PROFIT_COEFF_BASE * (grossMarginRate / ICT_MARGIN_THRESHOLD_LOW);
                                     profitCoefficientDesc = `收入≥${ICT_REVENUE_THRESHOLD/10000}万, 毛利率<${ICT_MARGIN_THRESHOLD_LOW}%`;
                                }
                            }
                        }

                         // 2. Calculate Current Points Payable (项目当前应发放积分) - Before Cap
                         let currentPointsPayableRaw = amountReceived * (grossMarginRate / 100) * profitCoefficient * (devContributionRatio / 100);
                         currentPointsPayableRaw = Math.max(0, currentPointsPayableRaw); // Ensure non-negative

                         // 3. Apply Total Project Cap (60,000)
                         const currentPointsPayableCapped = Math.min(currentPointsPayableRaw, ICT_TOTAL_POINTS_CAP);

                         // 4. Calculate Current Month Points (当月项目发放积分) - Before Cap
                         let currentMonthPointsRaw = currentPointsPayableCapped - historicalPoints;
                         currentMonthPointsRaw = Math.max(0, currentMonthPointsRaw); // Ensure non-negative

                         // 5. Apply Monthly Cap (5,000)
                         finalScore = Math.min(currentMonthPointsRaw, ICT_MONTHLY_POINTS_CAP);

                         calculationFactors = {
                            '计算类型': 'ICT项目',
                            '项目已回款金额累计值': `${amountReceived.toFixed(2)} 元`,
                            '项目总累计毛利率': `${grossMarginRate.toFixed(2)} %`,
                            '项目收入总额': `${totalRevenue.toFixed(2)} 元`,
                            '发展人贡献比': `${devContributionRatio.toFixed(2)} %`,
                            '利润系数': `${profitCoefficient.toFixed(4)} (${profitCoefficientDesc})`,
                            '项目历史已累计发放积分': `${historicalPoints.toFixed(3)}`,
                            '--- 计算过程 ---': '', // Separator
                            '当前应发放积分(未封顶)': `${currentPointsPayableRaw.toFixed(3)}`,
                            '当前应发放积分(上限6万)': `${currentPointsPayableCapped.toFixed(3)}`,
                            '当月发放积分(未封顶)': `${currentMonthPointsRaw.toFixed(3)}`,
                            '当月发放积分(上限5千)': `${finalScore.toFixed(3)}` // Final score is here
                         };
                        break;

                     default:
                         throw new Error('未知的计算类型。');
                }


                // --- Display Result ---
                if (Object.keys(calculationFactors).length > 0) {
                    let resultTitle = calculationFactors['计算类型'];
                    if(calculationFactors['品类']) { // For Dual Line, Fixed App
                        resultTitle += ` (${calculationFactors['品类']})`
                    } else if (selectedCalcType === 'broadband') { // For Broadband
                         // Corrected title generation for broadband
                         resultTitle = calculationFactors['计算类型']; // Use the title already set in the calculationFactors
                    }
                    detailsHtml = `<h3 class="text-md font-semibold mb-2 text-blue-900">${resultTitle} - 计算详情:</h3><ul>`;

                    for (const [key, value] of Object.entries(calculationFactors)) {
                        if (key !== '计算类型' && key !== '品类') {
                            // Special handling for separator
                            if (key.startsWith('---')) {
                                 detailsHtml += `<li class="text-sm font-semibold mt-1">${key.replace(/-/g, '')}</li>`;
                            } else if (key === '当月发放积分(上限5千)') { // Highlight final score
                                detailsHtml += `<li class="text-sm font-bold">${key}: ${value}</li>`;
                            }
                             else {
                                detailsHtml += `<li class="text-sm">${key}: ${value}</li>`;
                            }
                        }
                    }
                    detailsHtml += `</ul><hr class="my-2 border-blue-300">`;
                    // The final score for display is already calculated and capped above for ICT
                    // For other types, ensure it's not negative
                    if (selectedCalcType !== 'ict') {
                         finalScore = Math.max(0, finalScore);
                    }
                    detailsHtml += `<p class="font-bold text-lg text-center">最终计算积分: ${finalScore.toFixed(3)}</p>`; // Use the final capped score

                    resultDiv.innerHTML = detailsHtml;
                    resultDiv.className = 'result-box';
                } else {
                     throw new Error('未能执行计算。');
                }

            } catch (error) {
                // --- Display Error ---
                resultDiv.textContent = error.message;
                resultDiv.className = 'error-box';
            }
        });

        // --- Initial Setup ---
        document.querySelector('input[name="calc_type"]:checked').dispatchEvent(new Event('change'));
        if (document.querySelector('input[name="calc_type"]:checked').value === 'dual_line') {
             updateFormulaDisplay(dualLineSubtypeSelect, dlFormulaDisplay);
        }
        if (document.querySelector('input[name="calc_type"]:checked').value === 'fixed_app') {
             updateFormulaDisplay(fixedAppSubtypeSelect, faFormulaDisplay);
        }

    </script>
</body>
</html>
